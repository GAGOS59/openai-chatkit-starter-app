// app/api/efty/route.ts
import { NextResponse } from "next/server";
import OpenAI from "openai";
import { EFT_SYSTEM_PROMPT } from "./eft-prompt";

export const runtime = "nodejs";
export const dynamic = "force-dynamic";
export const revalidate = 0;

const openai = new OpenAI({
  apiKey: process.env.OPENAI_API_KEY,
});

/* ---------- Types ---------- */
type Role = "user" | "assistant";

interface ChatMessage {
  role: Role;
  content: string;
}

interface MotsClient {
  emotion?: string;
  sensation?: string;
  localisation?: string;
  pensee?: string;   // ex: "je n‚Äôy arriverai pas"
  souvenir?: string; // ex: "regard dur de mon chef"
}

interface BodyWithMessages {
  messages?: ChatMessage[];
}

interface BodyWithMessage {
  message?: string;
}

/**
 * Optionnel ‚Äî si pr√©sent, on g√©n√®re des candidats de rappels c√¥t√© app
 * et on les fournit au mod√®le dans un court JSON.
 */
interface BodyWithMotsClient {
  mots_client?: MotsClient;
  injectRappels?: boolean; // d√©faut: true
  rappelsVoulus?: number; // d√©faut: 6
}

type Payload = BodyWithMessages & BodyWithMessage & BodyWithMotsClient;

/* ---------- Utils ---------- */
// Normalise une cha√Æne: compresse les espaces et trim
function clean(s?: string): string {
  return (s ?? "").replace(/\s+/g, " ").trim();
}

function isChatMessageArray(x: unknown): x is ChatMessage[] {
  if (!Array.isArray(x)) return false;
  return x.every(
    (m) =>
      typeof m === "object" &&
      m !== null &&
      "role" in m &&
      "content" in m &&
      (m as { role: string }).role.match(/^(user|assistant)$/) &&
      typeof (m as { content: unknown }).content === "string"
  );
}

function isAllowedOrigin(origin: string | null): boolean {
  if (!origin) return false;
  const o = origin.toLowerCase();

  const ALLOWED_BASE = new Set<string>([
    "https://appli.ecole-eft-france.fr",
    "https://www.ecole-eft-france.fr",
  ]);

  const vercelEnv = process.env.VERCEL_ENV;
  const vercelUrl = process.env.VERCEL_URL ? `https://${process.env.VERCEL_URL}` : null;

  if (vercelEnv === "production") {
    return ALLOWED_BASE.has(o);
  }
  if (vercelEnv === "preview" && vercelUrl) {
    return o === vercelUrl || ALLOWED_BASE.has(o);
  }
  if (o.startsWith("http://localhost:") || o === "http://localhost") {
    return true;
  }
  return ALLOWED_BASE.has(o);
}

/* ---------- üîê S√©curit√© suicidaire : d√©tection & r√©ponses (serveur) ---------- */
/** √âtage 1 : signaux forts (id√©ation explicite) */
const CRISIS_HARD: RegExp[] = [
  /\bsuicid(e|er|aire|al|ale|aux|erai|erais|erait|eront)?\b/iu,
  /\bje\s+(veux|vais|voudrais)\s+mour(ir|ire)\b/iu,
  /\bje\s+ne\s+veux\s+plus\s+vivre\b/iu,
  /\bje\s+(veux|vais|voudrais)\s+en\s+finir\b/iu,
  /\bmettre\s+fin\s+√†\s+(ma|mes)\s+jours?\b/iu,
  /\b(kill\s+myself|i\s+want\s+to\s+die|suicide)\b/i,
  /\bme\s+tu(er|√©|erai|erais|erait|eront)?\b/iu,
  /\bme\s+pendre\b/iu,
  /\bplus\s+d[‚Äô']?envie\s+de\s+vivre\b/iu,
  /\bj[‚Äô']?\s*en\s+peux?\s+plus\s+de\s+vivre\b/iu,
];

/** √âtage 2 : signaux ‚Äúsouples‚Äù (d√©tresse lourde) ‚Üí question de s√©curit√© pos√©e */
const CRISIS_SOFT: RegExp[] = [
  /\bj[‚Äô']?\s*en\s+peux?\s+plus\b/iu,
  /\bj[‚Äô']?\s*en\s+ai\s+marre\b/iu,
  /\bmarre\s+de\s+vivre\b/iu,
  /\bras[-\s]?le[-\s]?bol\b/iu,
  /\bla\s+vie\s+en\s+g[√©e]n[√©e]ral\b/iu,
  /\bje\s+supporte\s+plus\s+(la\s+)?vie\b/iu,
  /\bla\s+vie\s+(me|m‚Äô)\s+(d[√©e]go[u√ª]te|fatigue|saoule)\b/iu,
  /\bid[√©e]es?\s+noires?\b/iu,
  /\bje\s+suis\s+(de\s+)?trop\b/iu,
];

function anyMatch(xs: RegExp[], s: string) {
  return xs.some((rx) => rx.test(s));
}

/* ‚Äî‚Äî‚Äî Versions tutoy√©es ‚Äî‚Äî‚Äî */
const ASK_SUICIDE_Q_TU =
  "Avant toute chose, as-tu des id√©es suicidaires en ce moment ? (r√©ponds par oui ou non)";

function crisisOrientationMessage_TU(): string {
  return `Message important
Il semble que tu traverses un moment tr√®s difficile. Je te prends au s√©rieux.
Je ne peux pas t‚Äôaccompagner avec l‚ÄôEFT dans une situation d‚Äôurgence : ta s√©curit√© est prioritaire.

üìû En France :
‚Ä¢ 3114 ‚Äî Pr√©vention du suicide (gratuit, 24/7)
‚Ä¢ 15 ‚Äî SAMU
‚Ä¢ 112 ‚Äî Urgences (si danger imm√©diat)

Tu n‚Äôes pas seul¬∑e ‚Äî ces services peuvent t‚Äôaider d√®s maintenant.`;
}

const YES_PATTERNS: RegExp[] = [
  /\b(oui|ouais|yep|yes)\b/i,
  /\b(plut[o√¥]t\s+)?oui\b/i,
  /\b(carr[√©e]ment|clairement)\b/i,
  /\b(je\s+c(r|‚Äô|')ains\s+que\s+oui)\b/i,
];
const NO_PATTERNS: RegExp[] = [
  /\b(non|nan|nope)\b/i,
  /\b(pas\s+du\s+tout|absolument\s+pas|vraiment\s+pas)\b/i,
  /\b(aucune?\s+id[√©e]e\s+suicidaire)\b/i,
  /\b(je\s+n['‚Äô]?ai\s+pas\s+d['‚Äô]?id[√©e]es?\s+suicidaires?)\b/i,
];

function interpretYesNoServer(text: string): "yes" | "no" | "unknown" {
  const t = (text || "").toLowerCase();
  if (YES_PATTERNS.some((rx) => rx.test(t))) return "yes";
  if (NO_PATTERNS.some((rx) => rx.test(t))) return "no";
  return "unknown";
}

/** A-t-on pos√© la question "avez-vous/as-tu des id√©es suicidaires" au tour assistant pr√©c√©dent ? */
function lastAssistantAskedSuicideQuestion(history: ChatMessage[]): boolean {
  for (let i = history.length - 1; i >= 0; i--) {
    const m = history[i];
    if (m.role === "assistant") {
      const t = (m.content || "").toLowerCase();
      return /avez[-\s]?vous\s+des\s+id[√©e]es?\s+suicidaires/.test(t) ||
             /as[-\s]?tu\s+des\s+id[√©e]es?\s+suicidaires/.test(t);
    }
    if (m.role === "user") break; // on s'arr√™te au dernier √©change
  }
  return false;
}

/* ---------- Micro-grammaire rappels (local, s√ªr, fid√®le Gary Craig) ---------- */
function generateRappelsBruts(m?: MotsClient): string[] {
  if (!m) return [];
  const out = new Set<string>();
  const push = (s?: string) => {
    if (!s) return;
    const t = s.trim().replace(/\s+/g, " ");
    if (t && t.length <= 40) out.add(t);
  };

  // patrons courts (neutres)
  if (m.emotion) push(`cette ${m.emotion}`);
  if (m.sensation && m.localisation) {
    const loc = m.localisation.trim();
    const prep = /^[aeiouh√¢√™√Æ√¥√ª√†√©√®√™√´√Ø√Æ√∂√¥√π]/i.test(loc)
      ? "l‚Äô"
      : (loc.match(/^(√©paule|hanche|jambe|cheville|main|gorge|poitrine|t√™te|machoire|m√¢choire|nuque|fesse|cuisse|cervelle|bouche|oreille|√©pigastre|cervicale|dent|√©paule)/i)
          ? "la "
          : (loc.match(/^(ventre|dos|bras|cou|pied|genou|mollet|front|thorax|cr√¢ne)/i) ? "le " : ""));
    const locFmt = prep ? `${prep}${loc.replace(/^l[‚Äô']\s*/i, "")}` : loc;
    push(`cette ${m.sensation} dans ${locFmt}`);
  }
  if (m.sensation && !m.localisation) push(`cette ${m.sensation}`);
  if (m.pensee) push(`cette pens√©e : ¬´ ${m.pensee} ¬ª`);
  if (m.souvenir) push(`ce souvenir qui revient`);
  if (m.localisation && !m.sensation) {
    const loc = m.localisation.trim();
    const prep = /^[aeiouh√¢√™√Æ√¥√ª√†√©√®√™√´√Ø√Æ√∂√¥√π]/i.test(loc)
      ? "l‚Äô"
      : (loc.match(/^(√©paule|hanche|jambe|cheville|main|gorge|poitrine|t√™te|machoire|m√¢choire|nuque|fesse|cuisse|cervelle|bouche|oreille|√©pigastre|cervicale|dent|√©paule)/i)
          ? "la "
          : (loc.match(/^(ventre|dos|bras|cou|pied|genou|mollet|front|thorax|cr√¢ne)/i) ? "le " : ""));
    const locFmt = prep ? `${prep}${loc.replace(/^l[‚Äô']\s*/i, "")}` : loc;
    push(`cette g√™ne dans ${locFmt}`);
  }

  // variantes tr√®s l√©g√®res
  if (m.emotion) push(`ce ${m.emotion} pr√©sent`);
  if (m.sensation && m.localisation) {
    const loc = m.localisation.trim();
    const prep = /^[aeiouh√¢√™√Æ√¥√ª√†√©√®√™√´√Ø√Æ√∂√¥√π]/i.test(loc)
      ? "l‚Äô"
      : (loc.match(/^(√©paule|hanche|jambe|cheville|main|gorge|poitrine|t√™te|machoire|m√¢choire|nuque|fesse|cuisse|cervelle|bouche|oreille|√©pigastre|cervicale|dent|√©paule)/i)
          ? "la "
          : (loc.match(/^(ventre|dos|bras|cou|pied|genou|mollet|front|thorax|cr√¢ne)/i) ? "le " : ""));
    const locFmt = prep ? `${prep}${loc.replace(/^l[‚Äô']\s*/i, "")}` : loc;
    push(`ce ${m.sensation} √† ${locFmt}`);
  }
  if (m.pensee) push(`cette pens√©e qui insiste`);

  return Array.from(out).slice(0, 10);
}

/* ---------- Handlers ---------- */
export async function POST(req: Request) {
  const origin = req.headers.get("origin");
  if (!isAllowedOrigin(origin)) {
    return new NextResponse("Origine non autoris√©e (CORS).", { status: 403 });
  }

  if (!process.env.OPENAI_API_KEY) {
    return NextResponse.json({ error: "Configuration manquante." }, { status: 500 });
  }

  let body: Payload = {};
  try {
    const raw = (await req.json()) as unknown;
    if (raw && typeof raw === "object") {
      body = raw as Payload;
    }
  } catch {
    return NextResponse.json({ error: "Requ√™te JSON invalide." }, { status: 400 });
  }

  const history: ChatMessage[] = isChatMessageArray(body.messages) ? body.messages : [];
  const single: string = typeof body.message === "string" ? body.message.trim() : "";

  const messages: Array<{ role: "system" | "user" | "assistant"; content: string }> = [
    { role: "system", content: EFT_SYSTEM_PROMPT },
  ];

  if (history.length > 0) {
    messages.push(...history.map((m) => ({ role: m.role, content: m.content })));
  } else if (single) {
    messages.push({ role: "user", content: single });
  } else {
    return NextResponse.json({ error: "Aucun message fourni." }, { status: 400 });
  }

  const headers = new Headers({
    "Content-Type": "application/json",
    "Access-Control-Allow-Origin": origin || "",
    "Vary": "Origin",
  });

  /* ---------- üîê Interception s√©curit√© AVANT mod√®le ---------- */
  const lastUserText =
    [...messages].reverse().find((m) => m.role === "user")?.content?.toLowerCase() ?? "";
  const askedSuicide = lastAssistantAskedSuicideQuestion(history);

  if (askedSuicide) {
    const yn = interpretYesNoServer(lastUserText);

    if (yn === "yes") {
      const answer =
        crisisOrientationMessage_TU() +
        "\n\nJe reste avec toi ici, mais je n‚Äôirai pas plus loin en EFT. " +
        "Appelle le 3114 ou le 112 si tu es en danger imm√©diat.";
      return new NextResponse(JSON.stringify({ answer, crisis: "lock" as const }), { headers });
    }

    if (yn === "no") {
      const answer =
        "Merci pour ta r√©ponse. Si √† un moment tu te sens en danger, stoppons l‚ÄôEFT et contacte le 3114 (24/7). " +
        "Quand tu es pr√™t¬∑e, dis en une phrase ce qui te d√©range le plus maintenant.";
      return new NextResponse(JSON.stringify({ answer, crisis: "none" as const }), { headers });
    }

    const answer = "Je n‚Äôai pas bien compris. Peux-tu r√©pondre par ¬´ oui ¬ª ou ¬´ non ¬ª, s‚Äôil te pla√Æt ?";
    return new NextResponse(JSON.stringify({ answer, crisis: "ask" as const }), { headers });
  }

  if (anyMatch(CRISIS_HARD, lastUserText)) {
    const answer = crisisOrientationMessage_TU() + "\n\n" + ASK_SUICIDE_Q_TU;
    return new NextResponse(JSON.stringify({ answer, crisis: "ask" as const }), { headers });
  }

  if (anyMatch(CRISIS_SOFT, lastUserText)) {
    const answer =
      "J‚Äôentends que c‚Äôest tr√®s difficile en ce moment. J‚Äôai une question importante de s√©curit√© avant de poursuivre.\n\n" +
      ASK_SUICIDE_Q_TU;
    return new NextResponse(JSON.stringify({ answer, crisis: "ask" as const }), { headers });
  }
  /* ---------- üîê Fin interception ---------- */

  // --- Injection optionnelle de candidats de rappels
  const injectRappels = body.injectRappels !== false; // par d√©faut true
  const rappelsVoulus = typeof body.rappelsVoulus === "number" ? body.rappelsVoulus : 6;
  const candidats = generateRappelsBruts(body.mots_client);

  if (injectRappels && candidats.length > 0) {
    messages.push({
      role: "user",
      content: JSON.stringify(
        {
          meta: "CANDIDATS_RAPPELS",
          candidats_app: candidats,
          voulu: rappelsVoulus,
        },
        null,
        2
      ),
    });
  }

/* ---------- üéØ Bloc A : d√©tection du type de d√©part (physique / √©motion / situation) ---------- */
const isPhysicalIntake = (s: string) =>
  /\b(mal|douleur|tension|crispation|g√™ne|br√ªlure|piq√ªre|raideur|contracture|migraine|maux?)\b/i.test(s);
const isEmotionIntake = (s: string) =>
  /\b(peur|col[e√®]re|tristesse|culpabilit[√©e]|angoisse|stress|honte|d√©go√ªt|inqui[√©e]tude|anxi[√©e]t[√©e]|√©nervement|d√©sespoir|impuissance|solitude|frustration|fatigue|lassitude)\b/i.test(s);
const isSituationIntake = (s: string) =>
  /\b(quand|lorsque|pendant|chaque\s+fois|√†\s+l‚Äôid√©e|au\s+moment|face\s+√†|devant|en\s+parlant|en\s+pensant)\b/i.test(s);

/* ü©π Physique ‚Äî douleur, tension, g√™ne */
if (isPhysicalIntake(lastUserText)) {
  return new NextResponse(
    JSON.stringify({
      answer: `Tu dis que tu as ${clean(lastUserMsg)}.  
Pr√©cise la localisation exacte et le type de douleur (lancinante, sourde, aigu√´‚Ä¶).  
Par exemple :  
‚Äì pour un genou : la rotule, la face interne ou externe, l‚Äôarri√®re du genou ;  
‚Äì pour la t√™te : les tempes, le front, l‚Äôarri√®re du cr√¢ne ;  
‚Äì pour le dos : les lombaires, entre les omoplates, la nuque.  
O√π ressens-tu exactement cette douleur ?`,
      crisis: "none" as const,
    }),
    { headers }
  );
}

/* üíì √âmotion ‚Äî peur, col√®re, tristesse, honte, etc. */
if (isEmotionIntake(lastUserText)) {
  return new NextResponse(
    JSON.stringify({
      answer: `Tu dis ¬´ ${clean(lastUserMsg)} ¬ª.  
Dans quelle situation ressens-tu ¬´ ${clean(lastUserMsg)} ¬ª ?  
Comment se manifeste ¬´ ${clean(lastUserMsg)} ¬ª dans ton corps quand tu penses √† cette situation ? (serrement, pression, chaleur, vide, etc.)  
Et o√π pr√©cis√©ment ressens-tu cette sensation ?`,
      crisis: "none" as const,
    }),
    { headers }
  );
}

/* üåø Situation ‚Äî contexte directement exprim√© */
if (isSituationIntake(lastUserText)) {
  return new NextResponse(
    JSON.stringify({
      answer: `Tu √©voques ¬´ ${clean(lastUserMsg)} ¬ª.  
Qu‚Äôest-ce qui te g√™ne le plus √† ce moment-l√† ?  
Quand tu y penses maintenant, que ressens-tu dans ton corps et o√π ?`,
      crisis: "none" as const,
    }),
    { headers }
  );
}
/* ---------- üéØ Bloc B : gestion du SUD et √©cart minimal de progression (fid√®le au prompt) ---------- */
const sudMatch = lastUserText.match(/^(?:sud\s*[:=]?\s*)?([0-9]|10)\s*$/i);
const lastAssistant = [...history].reverse().find((m) => m.role === "assistant")?.content || "";

if (sudMatch && /SUD/i.test(lastAssistant)) {
  const sud = parseInt(sudMatch[1], 10);

  // Retrouver le pr√©c√©dent SUD "nu" c√¥t√© user
  let prevSud: number | null = null;
  for (let i = history.length - 2; i >= 0; i--) {
    const m = history[i];
    if (m.role === "user") {
      const mm = (m.content || "").match(/^(?:sud\s*[:=]?\s*)?([0-9]|10)\s*$/i);
      if (mm) { prevSud = parseInt(mm[1], 10); break; }
    }
  }
  const delta = prevSud !== null ? (prevSud - sud) : null;

  /* --- Cas 1 : SUD = 0 --- */
  if (sud === 0) {
    return new NextResponse(JSON.stringify({
      answer:
        "Ton SUD est √† 0.\n" +
        "V√©rifie toujours l‚Äôaspect ou la situation initiale avant de conclure.\n" +
        "Si tout est √† 0 ‚Üí cl√¥ture : f√©licitations, hydratation, repos.\n" +
        "Si un √©l√©ment initial reste > 0 ‚Üí refais une courte ronde cibl√©e dessus.",
      crisis: "none" as const,
    }), { headers });
  }

  /* --- Cas 2 : SUD ‚â§ 1 --- */
  if (sud <= 1) {
    return new NextResponse(JSON.stringify({
      answer: "√áa pourrait √™tre quoi, ce petit reste ?",
      crisis: "none" as const,
    }), { headers });
  }

  /* --- Cas 3 : ŒîSUD = 1 --- */
  if (delta === 1) {
    return new NextResponse(JSON.stringify({
      answer:
        "Ton SUD n‚Äôa baiss√© que d‚Äôun point. Cela signifie que nous devons explorer ce qui maintient ce ressenti.\n" +
        "‚Äì Depuis quand ressens-tu cette douleur / cette √©motion ?\n" +
        "‚Äì Que se passait-il dans ta vie √† ce moment-l√† ?\n" +
        "‚Äì Si tu penses √† une p√©riode (ex. ¬´ depuis toute petite ¬ª) : cela te fait-il penser √† quelque chose de particulier ?\n" +
        "‚Äì Quand tu repenses √† cette p√©riode, que ressens-tu dans ton corps et o√π ?",
      crisis: "none" as const,
    }), { headers });
  }

  /* --- Cas 4 : ŒîSUD = 0 (ou hausse) --- */
  if (delta !== null && delta <= 0) {
    return new NextResponse(JSON.stringify({
      answer:
        "Le SUD n‚Äôa pas chang√©. Nous allons explorer la racine du probl√®me avant de continuer.\n" +
        "‚Äì Depuis quand ressens-tu cela ?\n" +
        "‚Äì Que se passait-il dans ta vie √† ce moment-l√† ?\n" +
        "‚Äì S‚Äôil y a une p√©riode en t√™te : cela te fait-il penser √† quelque chose de particulier ?\n" +
        "‚Äì Quand tu repenses √† cette p√©riode, que ressens-tu dans ton corps et o√π ?",
      crisis: "none" as const,
    }), { headers });
  }

  /* --- Cas 5 : ŒîSUD ‚â• 2 (et SUD > 0) --- */
  if (delta !== null && delta >= 2 && sud > 0) {
    return new NextResponse(JSON.stringify({
      answer:
        "Ton SUD a diminu√© d‚Äôau moins deux points. Nous poursuivons le travail sur ce m√™me ressenti.",
      crisis: "none" as const,
    }), { headers });
  }

  // Premier SUD (pas de pr√©c√©dent) ‚Üí laisser le mod√®le g√©rer la suite
}

  
  try {
    const completion = await openai.chat.completions.create({
      model: process.env.OPENAI_MODEL || "gpt-4o-mini",
      temperature: 0.5,
      messages,
    });

    const text =
      completion.choices?.[0]?.message?.content?.trim() ??
      "Je n‚Äôai pas compris. Peux-tu reformuler en une phrase courte ?";

    return new NextResponse(JSON.stringify({ answer: text, crisis: "none" as const }), { headers });
  } catch {
    return NextResponse.json(
      { error: "Service temporairement indisponible." },
      { status: 503 }
    );
  }
}

// Preflight CORS
export function OPTIONS(req: Request) {
  const origin = req.headers.get("origin");
  const headers: Record<string, string> = {
    "Access-Control-Allow-Origin": isAllowedOrigin(origin) ? origin! : "",
    "Access-Control-Allow-Methods": "POST, OPTIONS",
    "Access-Control-Allow-Headers": "Content-Type, Authorization",
  };
  return new NextResponse(null, { status: 204, headers });
}
